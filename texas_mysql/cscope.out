cscope 15 /data/work_prj/goprj/src/github.com/texas_mysql               0000020867
	@texas_mysql.go

1 
·ckage
 
maš


3 
impÜt
 (

9 
_
 "github.com/ziutek/mymysql/native"

25 
func
 
	$´štOK
() {

26 
fmt
.
	`Pršn
("OK")

27 
	}
}

29 
func
 
	$checkE¼Ü
(
”r
 
”rÜ
) {

30 
”r
 !ğ
n
 {

31 
fmt
.
	`Pršn
(
”r
)

33 
os
.
	`Ex™
(1)

35 
	}
}

37 
func
 
checkedResuÉ
(
rows
 []
mysql
.
Row
, 
»s
 mysql.
ResuÉ
, 
”r
 
”rÜ
è([]
	gmysql
.
	gRow
, mysql.
	gResuÉ
) {

38 
checkE¼Ü
(
”r
)

39  
	grows
, 
	g»s


42 
ty³
 
u£r
 struct {

43 
uid
 

46 
ty³
 
Cl›ÁE¼Ü
 
¡ršg


48 
	$func
 (
e
 
Cl›ÁE¼Ü
è
	$E¼Ü
(è
¡ršg
 {

49  
	`¡ršg
(
e
)

50 
	}
}

53 
MYSQL_TYPE_DECIMAL
 = 
iÙa


54 
MYSQL_TYPE_TINY


55 
MYSQL_TYPE_SHORT


56 
MYSQL_TYPE_LONG


57 
MYSQL_TYPE_FLOAT


58 
MYSQL_TYPE_DOUBLE


59 
MYSQL_TYPE_NULL


60 
MYSQL_TYPE_TIMESTAMP


61 
MYSQL_TYPE_LONGLONG


62 
MYSQL_TYPE_INT24


63 
MYSQL_TYPE_DATE


64 
MYSQL_TYPE_TIME


65 
MYSQL_TYPE_DATETIME


66 
MYSQL_TYPE_YEAR


67 
MYSQL_TYPE_NEWDATE


68 
MYSQL_TYPE_VARCHAR


69 
MYSQL_TYPE_BIT


70 
MYSQL_TYPE_NEWDECIMAL
 = 246

71 
MYSQL_TYPE_ENUM
 = 247

72 
MYSQL_TYPE_SET
 = 248

73 
MYSQL_TYPE_TINY_BLOB
 = 249

74 
MYSQL_TYPE_MEDIUM_BLOB
 = 250

75 
MYSQL_TYPE_LONG_BLOB
 = 251

76 
MYSQL_TYPE_BLOB
 = 252

77 
MYSQL_TYPE_VAR_STRING
 = 253

78 
MYSQL_TYPE_STRING
 = 254

79 
MYSQL_TYPE_GEOMETRY
 = 255

83 cÚ¡ 
FIELD_TYPE_DECIMAL
 = 
MYSQL_TYPE_DECIMAL


84 cÚ¡ 
FIELD_TYPE_NEWDECIMAL
 = 
MYSQL_TYPE_NEWDECIMAL


85 cÚ¡ 
FIELD_TYPE_TINY
 = 
MYSQL_TYPE_TINY


86 cÚ¡ 
FIELD_TYPE_SHORT
 = 
MYSQL_TYPE_SHORT


87 cÚ¡ 
FIELD_TYPE_LONG
 = 
MYSQL_TYPE_LONG


88 cÚ¡ 
FIELD_TYPE_FLOAT
 = 
MYSQL_TYPE_FLOAT


89 cÚ¡ 
FIELD_TYPE_DOUBLE
 = 
MYSQL_TYPE_DOUBLE


90 cÚ¡ 
FIELD_TYPE_NULL
 = 
MYSQL_TYPE_NULL


91 cÚ¡ 
FIELD_TYPE_TIMESTAMP
 = 
MYSQL_TYPE_TIMESTAMP


92 cÚ¡ 
FIELD_TYPE_LONGLONG
 = 
MYSQL_TYPE_LONGLONG


93 cÚ¡ 
FIELD_TYPE_INT24
 = 
MYSQL_TYPE_INT24


94 cÚ¡ 
FIELD_TYPE_DATE
 = 
MYSQL_TYPE_DATE


95 cÚ¡ 
FIELD_TYPE_TIME
 = 
MYSQL_TYPE_TIME


96 cÚ¡ 
FIELD_TYPE_DATETIME
 = 
MYSQL_TYPE_DATETIME


97 cÚ¡ 
FIELD_TYPE_YEAR
 = 
MYSQL_TYPE_YEAR


98 cÚ¡ 
FIELD_TYPE_NEWDATE
 = 
MYSQL_TYPE_NEWDATE


99 cÚ¡ 
FIELD_TYPE_ENUM
 = 
MYSQL_TYPE_ENUM


100 cÚ¡ 
FIELD_TYPE_SET
 = 
MYSQL_TYPE_SET


101 cÚ¡ 
FIELD_TYPE_TINY_BLOB
 = 
MYSQL_TYPE_TINY_BLOB


102 cÚ¡ 
FIELD_TYPE_MEDIUM_BLOB
 = 
MYSQL_TYPE_MEDIUM_BLOB


103 cÚ¡ 
FIELD_TYPE_LONG_BLOB
 = 
MYSQL_TYPE_LONG_BLOB


104 cÚ¡ 
FIELD_TYPE_BLOB
 = 
MYSQL_TYPE_BLOB


105 cÚ¡ 
FIELD_TYPE_VAR_STRING
 = 
MYSQL_TYPE_VAR_STRING


106 cÚ¡ 
FIELD_TYPE_STRING
 = 
MYSQL_TYPE_STRING


107 cÚ¡ 
FIELD_TYPE_CHAR
 = 
MYSQL_TYPE_TINY


108 cÚ¡ 
FIELD_TYPE_INTERVAL
 = 
MYSQL_TYPE_ENUM


109 cÚ¡ 
FIELD_TYPE_GEOMETRY
 = 
MYSQL_TYPE_GEOMETRY


110 cÚ¡ 
FIELD_TYPE_BIT
 = 
MYSQL_TYPE_BIT


112 
func
 
	$addSÏshes
(
¡r
 
¡ršg
) string {

114 
¡r
 = 
¡ršgs
.
	`R•Ïû
(str, "\\", "\\\\", -1)

115 
¡r
 = 
¡ršgs
.
	`R•Ïû
(str, "'", "\\'", -1)

116 
¡r
 = 
¡ršgs
.
	`R•Ïû
(str, "\"", "\\\"", -1)

118  
¡r


119 
	}
}

121 
func
 
	$g‘MysqlF›ldV®ue
(
row
 
mysql
.
Row
, 
f›ldName
 
¡ršg
, 
f›ldIndex
 , 
f›ldTy³
 
by‹
) string {

123 
f›ldTy³
 {

125 
FIELD_TYPE_LONG
, 
FIELD_TYPE_TINY
, 
FIELD_TYPE_SHORT
:

126 
v®
 :ğ
row
.
	`IÁ
(
f›ldIndex
)

127 
¡r
 :ğ
fmt
.
	`S´štf
("%d", 
v®
)

128 *
v”bo£
 {

129 
fmt
.
	`Prštf
("%20s: %s\n", 
f›ldName
, 
¡r
)

131  
¡r


133 
FIELD_TYPE_LONGLONG
:

134 
v®lÚg
 :ğ
row
.
	`IÁ64
(
f›ldIndex
)

135 
¡r
 :ğ
fmt
.
	`S´štf
("%d", 
v®lÚg
)

136 *
v”bo£
 {

137 
fmt
.
	`Prštf
("%20s: %s\n", 
f›ldName
, 
¡r
)

139  
¡r


141 
FIELD_TYPE_VAR_STRING
, 
MYSQL_TYPE_STRING
:

142 
¡r
 :ğ
row
.
	`SŒ
(
f›ldIndex
)

143 
¡r
 = 
	`addSÏshes
(str)

144 *
v”bo£
 {

145 
fmt
.
	`Prštf
("%20s: %s\n", 
f›ldName
, 
¡r
)

147  "\"" + 
¡r
 + "\""

150 
fmt
.
	`Pršn
("”r:", 
f›ldName
, 
f›ldIndex
, 
f›ldTy³
)

154 
	}
}

156 
ty³
 
mysqlTabËD©a
 struct {

157 
š£¹SqlP»fix
 
¡ršg


158 
´efixIniæag
 
by‹


160 
£l
 
	mmysql
.
Stmt


161 
bË
 
¡ršg


162 
couÁ”
 
	mšt32


165 
ty³
 
WÜk”
 struct {

166 
wÜk”Id
 

167 
¤cDb
 
	mmysql
.
CÚn


168 
d¡Db
 
	mmysql
.
CÚn


170 
¡¬tTime
 
	mtime
.
Time


171 
	mbËSliû
 []
	mmysqlTabËD©a


174 
	$func
 (
wk
 *
WÜk”
è
	$DbP»·»
(
sqlS–eù
 
¡ršg
, 
sqlFrom
 sŒšg, 
sqlIÂ”
 sŒšg, 
sqlWh”e
 sŒšgè
”rÜ
 {

176 
sql
 :ğ"£Ëù " + 
sqlS–eù
 + " from " + "`" + 
sqlFrom
 + "`" + 
sqlIÂ”
 + " wh”" + 
sqlWh”e


178 *
v”bo£
 {

179 
fmt
.
	`Pršn
("DbP»·» sql:", 
sql
)

182 
£l
, 
”r
 :ğ
wk
.
¤cDb
.
	`P»·»
(
sql
)

184 
”r
 =ğ
n
 {

185 
bËD©a
 :ğ
	`Ãw
(
mysqlTabËD©a
)

187 
bËD©a
.
£l
 = sel

188 
bËD©a
.
bË
 = 
sqlFrom


189 
bËD©a
.
´efixIniæag
 = 0

190 
wk
.
bËSliû
 = 
	`­³nd
(wk.bËSliû, *
bËD©a
)

193 
fmt
.
	`Pršn
(
sql
)

194  
”rÜs
.
	`New
("DbPrepare:‡uthenticationƒrror")

197  
n


198 
	}
}

200 
	$func
 (
wk
 *
WÜk”
è
	$ProûssMysqlStmt
(
¶ay”Uid
 è
”rÜ
 {

205 
i
, 
bËD©a
 :ğ
¿nge
 
wk
.
bËSliû
 {

208 
rows
, 
»s
 :ğ
	`checkedResuÉ
(
bËD©a
.
£l
.
	`Exec
(
¶ay”Uid
))

210 
v¬
 
f›ldIndex
 

211 
v¬
 
f›ldV®ueSŒ
 
¡ršg


212 
v¬
 
sqlP»fix
 
¡ršg


213 
v¬
 
sql
 
¡ršg


216 
bËD©a
.
š£¹SqlP»fix
 == "" {

218 
sqlP»fix
 = "š£¹ iÁØ" + 
bËD©a
.
bË
 + " ("

221 
_
, 
f›ld
 :ğ
¿nge
 
»s
.
	`F›lds
() {

223 
f›ldIndex
 == 0 {

224 
sqlP»fix
 +ğ"`" + 
f›ld
.
Name
 + "`"

226 
sqlP»fix
 +ğ",`" + 
f›ld
.
Name
 + "`"

229 
f›ldIndex
++

235 
sqlP»fix
 += ") "

237 
bËD©a
.
š£¹SqlP»fix
 = 
sqlP»fix


238 
wk
.
bËSliû
[
i
].
š£¹SqlP»fix
 = 
sqlP»fix


240 
sqlP»fix
 = 
bËD©a
.
š£¹SqlP»fix


243 
sqlP»fix
 += "values("

245 
_
, 
row
 :ğ
¿nge
 
rows
 {

247 
f›ldIndex
 = 0

248 
sql
 = 
sqlP»fix


251 
_
, 
f›ld
 :ğ
¿nge
 
»s
.
	`F›lds
() {

253 
f›ldV®ueSŒ
 = 
	`g‘MysqlF›ldV®ue
(
row
, 
f›ld
.
Name
, 
f›ldIndex
, f›ld.
Ty³
)

255 
f›ldIndex
 == 0 {

256 
sql
 +ğ
f›ldV®ueSŒ


258 
sql
 +ğ"," + 
f›ldV®ueSŒ


261 
f›ldIndex
++

264 
sql
 += ")"

266 *
v”bo£
 {

267 
fmt
.
	`Pršn
(
sql
)

278 
wk
.
bËSliû
[
i
].
couÁ”
++

284  
n


286 
	}
}

288 
func
 
	$FlushMysqlCache
(
tıCÚ
 *
tıCÚÃù
è
”rÜ
 {

289 
¤cDb
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
¤cPrÙo
, "",ıCÚ.
¤cAddr
,ıCÚ.
¤cU£r
,ıCÚ.
¤cPass
,ıCÚ.
¤cDbÇme
)

291 
d¡Db
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
¤cPrÙo
, "",ıCÚ.
¤cAddr
,ıCÚ.
¤cU£r
,ıCÚ.
¤cPass
,ıCÚ.
¤cDbÇme
)

293 
fmt
.
	`Prštf
("FlushMysqlCache: CÚÃùØ¤cDb:%s:%s...\n", 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

294 
fmt
.
	`Prštf
("FlushMysqlCache: CÚÃùØd¡Db:%s:%s...\n", 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

296 
	`checkE¼Ü
(
¤cDb
.
	`CÚÃù
())

297 
	`checkE¼Ü
(
d¡Db
.
	`CÚÃù
())

299 
deãr
 
¤cDb
.
	`Clo£
()

300 
deãr
 
d¡Db
.
	`Clo£
()

302 
upd©e
, 
”r
 :ğ
d¡Db
.
	`P»·»
("update `texas_user` set `experience`=?,`win`=?,`lose`=?,`discard`=?,`gamemoney`=?,`gamegold`=? where `id`=?")

303 
	`checkE¼Ü
(
”r
)

305 
v¬
 
sql
 
¡ršg


308 
i
 := 0; i < 10; i++ {

309 
sql
 = 
fmt
.
	`S´štf
("£Ëù * from `‹xas_u£r_%d`", 
i
)

310 
fmt
.
	`Pršn
("Proûss: ", 
sql
)

311 
»s
, 
”r
 :ğ
¤cDb
.
	`S¹
(
sql
)

312 
	`checkE¼Ü
(
”r
)

314 
row
 :ğ
»s
.
	`MakeRow
()

316 
uid
 :ğ
»s
.
	`M­
("uid")

317 
ex³r›nû
 :ğ
»s
.
	`M­
("experience")

318 
disÿrd
 :ğ
»s
.
	`M­
("discard")

319 
wš
 :ğ
»s
.
	`M­
("win")

320 
lo£
 :ğ
»s
.
	`M­
("lose")

321 
gamemÚey
 :ğ
»s
.
	`M­
("gamemoney")

322 
gamegŞd
 :ğ
»s
.
	`M­
("gamegold")

325 
”r
 :ğ
»s
.
	`SÿnRow
(
row
)

326 
”r
 =ğ
io
.
EOF
 {

331 
	`checkE¼Ü
(
”r
)

345 
_
, _, 
”r
 = 
upd©e
.
	`Exec
(
row
.
	`IÁ
(
ex³r›nû
),„ow.IÁ(
wš
),„ow.IÁ(
lo£
),„ow.IÁ(
disÿrd
),„ow.
	`IÁ64
(
gamemÚey
),„ow.IÁ64(
gamegŞd
),„ow.IÁ(
uid
))

347 
	`checkE¼Ü
(
”r
)

351  
n


352 
	}
}

354 
func
 
	$P»ûssChampiÚsh
(
tıCÚ
 *
tıCÚÃù
) (, ) {

355 
¤cDb
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
¤cPrÙo
, "",ıCÚ.
¤cAddr
,ıCÚ.
¤cU£r
,ıCÚ.
¤cPass
,ıCÚ.
¤cDbÇme
)

357 
d¡Db
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
d¡PrÙo
, "",ıCÚ.
d¡Addr
,ıCÚ.
d¡U£r
,ıCÚ.
d¡Pass
,ıCÚ.
d¡DbÇme
)

359 
fmt
.
	`Prštf
("P»ûssChampiÚsh: CÚÃùØ¤cDb:%s:%s...\n", 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

360 
fmt
.
	`Prštf
("P»ûssChampiÚsh: CÚÃùØd¡Db:%s:%s...\n", 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

362 
	`checkE¼Ü
(
¤cDb
.
	`CÚÃù
())

363 
	`checkE¼Ü
(
d¡Db
.
	`CÚÃù
())

365 
deãr
 
¤cDb
.
	`Clo£
()

366 
deãr
 
d¡Db
.
	`Clo£
()

369 
š£¹
, 
”r
 :ğ
d¡Db
.
	`P»·»
("insert into `texas_championship` values (?,?,?,?,?,?,?)")

370 
	`checkE¼Ü
(
”r
)

372 
v¬
 
sql
 
¡ršg


374 
tm
 :ğ
time
.
	`Now
().
	`Unix
()

375 
mšId
 := 1 << 16

377 
sql
 = 
fmt
.
	`S´štf
("£Ëù * from `‹xas_champiÚsh` wh”`¡¬‰ime` > %d", 
tm
)

378 
fmt
.
	`Pršn
("Proûss: ", 
sql
)

379 
»s
, 
”r
 :ğ
¤cDb
.
	`S¹
(
sql
)

380 
	`checkE¼Ü
(
”r
)

382 
row
 :ğ
»s
.
	`MakeRow
()

384 
champId
 :ğ
»s
.
	`M­
("id")

385 
champTy³
 :ğ
»s
.
	`M­
("type")

386 
champTime
 :ğ
»s
.
	`M­
("time")

387 
champS¹time
 :ğ
»s
.
	`M­
("starttime")

388 
champEndtime
 :ğ
»s
.
	`M­
("endtime")

389 
champBÚus
 :ğ
»s
.
	`M­
("Bonus")

390 
champCÚfig_id
 :ğ
»s
.
	`M­
("config_id")

392 
rowCouÁ
 := 0

394 
”r
 :ğ
»s
.
	`SÿnRow
(
row
)

395 
”r
 =ğ
io
.
EOF
 {

400 
rowCouÁ
++

402 
	`checkE¼Ü
(
”r
)

404 
mšId
 > 
row
.
	`IÁ
(
champId
) {

405 
mšId
 = 
row
.
	`IÁ
(
champId
)

407 
_
, _, 
”r
 = 
š£¹
.
	`Exec
(
row
.
	`IÁ
(
champId
),„ow.IÁ(
champTy³
),„ow.IÁ(
champTime
),„ow.IÁ(
champS¹time
),„ow.IÁ(
champEndtime
),„ow.IÁ(
champBÚus
),„ow.IÁ(
champCÚfig_id
))

409 
	`checkE¼Ü
(
”r
)

412  
mšId
, 
rowCouÁ


413 
	}
}

415 
func
 
	$g‘Uids
(
uids
 *[], 
£l
 
mysql
.
Stmt
, 
¡¬tUid
 è
”rÜ
 {

417 
rows
, 
»s
 :ğ
	`checkedResuÉ
(
£l
.
	`Exec
(
¡¬tUid
))

431 
id
 :ğ
»s
.
	`M­
("id")

434 
_
, 
row
 :ğ
¿nge
 
rows
 {

439 *
uids
 = 
	`­³nd
(*uids, 
row
.
	`IÁ
(
id
))

442  
n


443 
	}
}

445 
ty³
 
tıCÚÃù
 struct {

446 
¤cU£r
 
¡ršg


447 
¤cPass
 
¡ršg


448 
¤cDbÇme
 
¡ršg


449 
¤cPrÙo
 
¡ršg


450 
¤cAddr
 
¡ršg


452 
d¡U£r
 
¡ršg


453 
d¡Pass
 
¡ršg


454 
d¡DbÇme
 
¡ršg


455 
d¡PrÙo
 
¡ršg


456 
d¡Addr
 
¡ršg


458 
­pId
 

461 
ty³
 
¡©i¡ics
 struct {

462 
m­d©a
 
	mm­
[
¡ršg
]
št32


463 
	msync
.
	mMu‹x


466 
func
 
ÃwWÜk”
(
wÜk”Id
 è*
	gWÜk”
 {

467 
	gn
 :ğ&
WÜk”
{

468 
wÜk”Id
: workerId,

469 
bËSliû
: []
mysqlTabËD©a
{},

472  
n


475 
func
 
	$g‘UidWÜk”
(
tıCÚ
 *
tıCÚÃù
, 
uidChª
 
chª
 , 
ex™Chª
 chª è
”rÜ
 {

477 
¤cDb
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
¤cPrÙo
, "",ıCÚ.
¤cAddr
,ıCÚ.
¤cU£r
,ıCÚ.
¤cPass
,ıCÚ.
¤cDbÇme
)

480 
fmt
.
	`Prštf
("g‘UidWÜk” CÚÃùØ¤cDb:%s:%s...\n", 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

483 
	`checkE¼Ü
(
¤cDb
.
	`CÚÃù
())

485 
deãr
 
¤cDb
.
	`Clo£
()

488 
fmt
.
	`Pršn
("getUidWorker åˆå§‹åŒ–å®Œæˆ")

492 
¡¬t
 :ğ
time
.
	`Now
()

494 
uids
 :ğ
	`make
([], 0, 100)

496 
¡¬tUid
 := 0

498 
£l
, 
”r
 :ğ
¤cDb
.
	`P»·»
(
fmt
.
	`S´štf
("£Ëù `id` from `‹xas_u£r` wh”`id` > ?‡nd `­pid`=%d ord” by `id`†im™ 100", 
tıCÚ
.
­pId
))

499 
	`checkE¼Ü
(
”r
)

501 
row
, 
_
, 
”r
 :ğ
¤cDb
.
	`Qu”yFœ¡
(
fmt
.
	`S´štf
("£Ëù couÁ(*èa `tÙ®` from `‹xas_u£r` wh”`­pid`=%d", 
tıCÚ
.
­pId
))

502 
	`checkE¼Ü
(
”r
)

504 
tÙ®Uid
 :ğ
row
.
	`IÁ
(0)

505 
fmt
.
	`Prštf
("tÙ® uid ğ%d\n", 
tÙ®Uid
)

507 
v¬
 
cu¼’tUid
 
æßt64


508 
³rûÁage
 := 0

512 
	`g‘Uids
(&
uids
, 
£l
, 
¡¬tUid
)

516 
v¬
 
uid
 

517 
_
, 
uid
 = 
¿nge
 
uids
 {

519 *
v”bo£
 {

520 
fmt
.
	`Prštf
("puˆuid=%d iÁØuidChª\n", 
uid
)

523 
¡¬tUid
 = 
uid


525 
uidChª
 <- 
uid


527 
cu¼’tUid
++

530 
tmpP”ûÁage
 :ğ
cu¼’tUid
 / 
	`æßt64
(
tÙ®Uid
è* 100; ÑmpP”ûÁageè!ğ
³rûÁage
 {

532 
–­£dTime
 :ğ
time
.
	`Sšû
(
¡¬t
)

534 
³rûÁage
 = (
tmpP”ûÁage
)

536 
fmt
.
	`Prštf
("Prog»ss: %2d%%ƒÏp£dime: %s\n", 
³rûÁage
, 
–­£dTime
)

544 
uids
 = []{}

546 
¡¬tUid
 !ğ
uid
 {

547 
¡¬tUid
 = 
uid


550 
uid
 == 0 {

551 
ex™


555 
ex™
:

556 
	`Ën
(
uidChª
) != 0 {

557 
time
.
	`SË•
Ñime.
Mli£cÚd
 * 100)

558 
fmt
.
	`Pršn
("progressƒxiting: wait uidChan„ead finish")

559 
ex™


562 
fmt
.
	`Pršn
("progressƒxit")

564 
	`şo£
(
ex™Chª
)

566  
n


568 
	}
}

570 
func
 
	$pubWÜk”
(
tıCÚ
 *
tıCÚÃù
, 
uidChª
 
chª
 , 
ex™Chª
 chª , 
wÜk”Id
 , 
¡¬tTime
 
time
.
Time
, 
¡©
 *
¡©i¡ics
, 
champId
 è
”rÜ
 {

572 
¤cDb
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
¤cPrÙo
, "",ıCÚ.
¤cAddr
,ıCÚ.
¤cU£r
,ıCÚ.
¤cPass
,ıCÚ.
¤cDbÇme
)

573 
d¡Db
 :ğ
thr§ã
.
	`New
(
tıCÚ
.
d¡PrÙo
, "",ıCÚ.
d¡Addr
,ıCÚ.
d¡U£r
,ıCÚ.
d¡Pass
,ıCÚ.
d¡DbÇme
)

575 
fmt
.
	`Prštf
("wÜk”: %d CÚÃùØ¤cDb:%s:%s...\n", 
wÜk”Id
, 
tıCÚ
.
¤cPrÙo
,ıCÚ.
¤cAddr
)

576 
fmt
.
	`Prštf
("wÜk”: %d CÚÃùØd¡Db:%s:%s...\n", 
wÜk”Id
, 
tıCÚ
.
d¡PrÙo
,ıCÚ.
d¡Addr
)

578 
	`checkE¼Ü
(
¤cDb
.
	`CÚÃù
())

579 
	`checkE¼Ü
(
d¡Db
.
	`CÚÃù
())

581 
fmt
.
	`Prštf
("wÜk”: %d åˆå§‹åŒ–æˆåŠŸ\n", 
wÜk”Id
)

583 
deãr
 
¤cDb
.
	`Clo£
()

584 
deãr
 
d¡Db
.
	`Clo£
()

586 
tm
 :ğ
time
.
	`Now
().
	`Unix
()

588 
wÜk”
 :ğ
	`ÃwWÜk”
(
wÜk”Id
)

590 
wÜk”
.
¤cDb
 = srcDb

591 
wÜk”
.
d¡Db
 = dstDb

592 
wÜk”
.
¡¬tTime
 = startTime

597 
”r
 :ğ
wÜk”
.
	`DbP»·»
("*", "texas_user", "", "id = ?†imit 1")

598 
	`checkE¼Ü
(
”r
)

602 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "‹xas_u£r_v", "", 
fmt
.
	`S´štf
("uid = ?‡nd (expœ‘imğ0 o¸expœ‘im> %d)", 
tm
))

603 
	`checkE¼Ü
(
”r
)

607 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "‹xas_u£r_expÿrd", "", 
fmt
.
	`S´štf
("uid = ?‡nd (’d_tim=0 o¸’d_tim> %d)", 
tm
))

608 
	`checkE¼Ü
(
”r
)

611 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_loudspeaker", "", "uid = ?‡nd `amount` != 0 ")

612 
	`checkE¼Ü
(
”r
)

615 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "‹xas_u£r_´İs", "", 
fmt
.
	`S´štf
("uid = ?‡nd `expœ‘ime` > %d", 
tm
))

616 
	`checkE¼Ü
(
”r
)

619 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_expression", "", "uid = ?‡nd `amount`!=0")

620 
	`checkE¼Ü
(
”r
)

623 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_achievement", "", "uid = ?")

624 
	`checkE¼Ü
(
”r
)

627 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_friend", "", "uid = ?")

628 
	`checkE¼Ü
(
”r
)

631 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_dealer", "", "uid = ?")

632 
	`checkE¼Ü
(
”r
)

635 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_task", "", "uid = ?")

636 
	`checkE¼Ü
(
”r
)

639 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_course_award", "", "uid = ?")

640 
	`checkE¼Ü
(
”r
)

643 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_dajiale", "", "uid = ?")

644 
	`checkE¼Ü
(
”r
)

647 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_step", "", "uid = ?")

648 
	`checkE¼Ü
(
”r
)

651 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_chest", "", "uid = ?")

652 
	`checkE¼Ü
(
”r
)

655 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_ban", "", "uid = ?")

656 
	`checkE¼Ü
(
”r
)

659 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_room_log", "", "uid = ?")

660 
	`checkE¼Ü
(
”r
)

663 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_user_lucky_wheel", "", "uid = ?")

664 
	`checkE¼Ü
(
”r
)

671 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "‹xas_champiÚsh_»gi¡¿tiÚ", "", 
fmt
.
	`S´štf
("`uid`=?‡nd `champiÚsh_id` > %d", 
champId
))

672 
	`checkE¼Ü
(
”r
)

675 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_order", "", "`uid`=?")

676 
	`checkE¼Ü
(
”r
)

678 
”r
 = 
wÜk”
.
	`DbP»·»
("texas_order_facebook.*", "texas_order_facebook", "inner join `texas_order` on `orderid`=`texas_order`.`id`", "`texas_order`.`uid`=?")

679 
	`checkE¼Ü
(
”r
)

681 
”r
 = 
wÜk”
.
	`DbP»·»
("texas_order_apple.*", "texas_order_apple", "inner join `texas_order` on `orderid`=`texas_order`.`id`", "`texas_order`.`uid`=?")

682 
	`checkE¼Ü
(
”r
)

684 
”r
 = 
wÜk”
.
	`DbP»·»
("texas_order_google.*", "texas_order_google", "inner join `texas_order` on `orderid`=`texas_order`.`id`", "`texas_order`.`uid`=?")

685 
	`checkE¼Ü
(
”r
)

687 
”r
 = 
wÜk”
.
	`DbP»·»
("*", "texas_order_google_log", "", "`uid`=?")

688 
	`checkE¼Ü
(
”r
)

690 
”r
 = 
wÜk”
.
	`DbP»·»
("texas_order_facebook_log.*", "texas_order_facebook_log",

694 
	`checkE¼Ü
(
”r
)

696 
”r
 = 
wÜk”
.
	`DbP»·»
("texas_order_facebook_log.*", "texas_order_facebook_log", "inner join `texas_order_facebook` on `texas_order_facebook_log`.`facebook_order`=`texas_order_facebook`.`orderid` inner join `texas_order` on `texas_order`.`id`=`texas_order_facebook`.`orderid`", "`texas_order`.`uid`=?")

697 
	`checkE¼Ü
(
”r
)

701 
£Ëù
 {

702 
uid
, 
ok
 :ğ<-
uidChª
:

703 
ok
 {

704 *
v”bo£
 {

705 
fmt
.
	`Pršn
("´oûs uid:", 
uid
)

708 
wÜk”
.
	`ProûssMysqlStmt
(
uid
)

712 
fmt
.
	`Prštf
("wÜk”: %d uidChª clo£\n", 
wÜk”Id
)

713 
ex™Tab


716 <-
ex™Chª
:

718 
ex™Tab


722 
ex™Tab
:

723 
fmt
.
	`Prštf
("wÜk”: %dƒx™\n", 
wÜk”Id
)

724 
_
, 
bËD©a
 :ğ
¿nge
 
wÜk”
.
bËSliû
 {

725 
¡©
.
	`Lock
()

726 
¡©
.
m­d©a
[
bËD©a
.
bË
] +ğbËD©a.
couÁ”


727 
¡©
.
	`UÆock
()

729  
n


730 
	}
}

732 
func
 
	$g’”®CÚfigFe
() {

733 
b
 :ğ[]
	`by‹
(

734 `[
Aµ
]

735 
AµID
=1

737 [
SrcDB
]

738 
Name
=
‹xas


739 
U£r
=
‹xas


740 
Ip
=172.16.5.200

741 
PÜt
=3306

742 
Pwd
=

744 [
D¡DB
]

745 
Name
=
‹xas_hung¬y


746 
U£r
=
‹xas


747 
Ip
=172.16.5.200

748 
PÜt
=3306

749 
Pwd
=

751 
”r
 :ğ
iout
.
	`Wr™eFe
("‹xas_mysql.ši", 
b
, 0644)

752 
”r
 !ğ
n
 {

753 
log
.
	`F©®f
("FaedØg’”®exas_mysql.ši: %s", 
”r
)

756 
fmt
.
	`Pršn
("generalexas_mysql.ini successful")

757 
	}
}

759 
v¬
 (

762 
v”bo£
 = 
æag
.
BoŞ
("v”bo£", 
çl£
, "enable verbose†ogging")

763 
outPutCÚfigFe
 = 
æag
.
BoŞ
("o", 
çl£
, "generateheexas_mysql.ini file")

766 
ty³
 
CÚfig
 struct {

767 
Aµ
 struct {

768 
AµID
 

771 
SrcDB
 struct {

772 
Name
 
¡ršg


773 
U£r
 
¡ršg


774 
Ip
 
¡ršg


775 
PÜt
 
¡ršg


776 
Pwd
 
	m¡ršg


779 
D¡DB
 struct {

780 
Name
 
¡ršg


781 
U£r
 
¡ršg


782 
Ip
 
¡ršg


783 
PÜt
 
¡ršg


784 
Pwd
 
	m¡ršg


788 
func
 
	$maš
() {

790 
v¬
 
cfg
 
CÚfig


791 
v¬
 
d¡DbPwd
 
¡ršg


792 
v¬
 
¤cDbPwd
 
¡ršg


794 
æag
.
	`P¬£
()

795 *
outPutCÚfigFe
 {

796 
	`g’”®CÚfigFe
()

800 
”r
 :ğ
gcfg
.
	`R—dFeIÁo
(&
cfg
, "texas_mysql.ini")

801 
”r
 !ğ
n
 {

802 
log
.
	`F©®f
("FaedØ·r£exas_mysql.ši: %s", 
”r
)

805 
fmt
.
	`Pršn
("­pid: ", 
cfg
.
Aµ
.
AµID
)

807 
fmt
.
	`Pršn
("SrcDB Name:", 
cfg
.
SrcDB
.
Name
)

808 
fmt
.
	`Pršn
("SrcDB U£r:", 
cfg
.
SrcDB
.
U£r
)

809 
fmt
.
	`Pršn
("SrcDB Ip:", 
cfg
.
SrcDB
.
Ip
)

810 
fmt
.
	`Pršn
("SrcDB PÜt:", 
cfg
.
SrcDB
.
PÜt
)

811 
fmt
.
	`Pršn
("SrcDB Pwd:", 
cfg
.
SrcDB
.
Pwd
)

813 
fmt
.
	`Pršn
("D¡DB Name:", 
cfg
.
D¡DB
.
Name
)

814 
fmt
.
	`Pršn
("D¡DB PÜt:", 
cfg
.
D¡DB
.
PÜt
)

815 
fmt
.
	`Pršn
("D¡DB Ip:", 
cfg
.
D¡DB
.
Ip
)

816 
fmt
.
	`Pršn
("D¡DB U£r:", 
cfg
.
D¡DB
.
U£r
)

817 
fmt
.
	`Pršn
("D¡DB Pwd:", 
cfg
.
D¡DB
.
Pwd
)

819 
cfg
.
Aµ
.
AµID
 == 0 {

820 
log
.
	`F©®f
("config: AppIDƒrr")

823 
cfg
.
SrcDB
.
Name
 == "" {

824 
log
.
	`F©®f
("config: SrcDB Nameƒrr")

827 
cfg
.
SrcDB
.
Ip
 == "" {

828 
log
.
	`F©®f
("config: SrcDB Ipƒrr")

831 
cfg
.
SrcDB
.
U£r
 == "" {

832 
log
.
	`F©®f
("config: SrcDB Userƒrr")

835 
cfg
.
D¡DB
.
Name
 == "" {

836 
log
.
	`F©®f
("config: DstDB Nameƒrr")

839 
cfg
.
D¡DB
.
Ip
 == "" {

840 
log
.
	`F©®f
("config: DstDB Ipƒrr")

843 
cfg
.
D¡DB
.
U£r
 == "" {

844 
log
.
	`F©®f
("config: DstDB Userƒrr")

847 
cfg
.
SrcDB
.
Pwd
 == "" {

848 
fmt
.
	`Pršn
("please inputhe SrcDB…assword")

849 
¤cDbPwd
 = 
	`¡ršg
(
gİass
.
	`G‘Passwd
())

851 
¤cDbPwd
 = 
cfg
.
SrcDB
.
Pwd


854 
cfg
.
D¡DB
.
Pwd
 == "" {

855 
fmt
.
	`Pršn
("please inputhe DstDB…assword")

856 
d¡DbPwd
 = 
	`¡ršg
(
gİass
.
	`G‘Passwd
())

858 
d¡DbPwd
 = 
cfg
.
D¡DB
.
Pwd


861 
tıCÚ
 :ğ
	`Ãw
(
tıCÚÃù
)

862 
tıCÚ
.
¤cU£r
 = 
cfg
.
SrcDB
.
U£r


863 
tıCÚ
.
¤cPass
 = 
¤cDbPwd


864 
tıCÚ
.
¤cDbÇme
 = 
cfg
.
SrcDB
.
Name


865 
tıCÚ
.
¤cPrÙo
 = "tcp"

866 
tıCÚ
.
¤cAddr
 = 
cfg
.
SrcDB
.
Ip
 + ":" + cfg.SrcDB.
PÜt


868 
tıCÚ
.
d¡U£r
 = 
cfg
.
D¡DB
.
U£r


869 
tıCÚ
.
d¡Pass
 = 
d¡DbPwd


870 
tıCÚ
.
d¡DbÇme
 = 
cfg
.
D¡DB
.
Name


871 
tıCÚ
.
d¡PrÙo
 = "tcp"

872 
tıCÚ
.
d¡Addr
 = 
cfg
.
D¡DB
.
Ip
 + ":" + cfg.D¡DB.
PÜt


874 
tıCÚ
.
­pId
 = 
cfg
.
Aµ
.
AµID


877 
fmt
.
	`Pršn
("press Enter keyo continue or Ctrl-C for break")

878 
bufio
.
	`NewR—d”
(
os
.
Stdš
).
	`R—dBy‹s
('\n')

881 
ıusNum
 :ğ
ruÁime
.
	`GOMAXPROCS
(0)

882 
ıusNum
 = 4

884 
uidsChª
 :ğ
	`make
(
chª
 , 
ıusNum
)

885 
ex™Chª
 :ğ
	`make
(
chª
 )

887 
	`FlushMysqlCache
(
tıCÚ
è=ğ
n
 {

888 
fmt
.
	`Pršn
("flush mysqlexas_user_x cache successful.\n\n")

891 
champId
, 
champCouÁ
 :ğ
	`P»ûssChampiÚsh
(
tıCÚ
)

892 
fmt
.
	`Pršn
(fmt.
	`S´štf
("vad champiÚsh champCouÁ=%d mšId=%d",
champCouÁ
, 
champId
))

893 
fmt
.
	`Pršn
()

895 
go
 
	`g‘UidWÜk”
(
tıCÚ
, 
uidsChª
, 
ex™Chª
)

897 
v¬
 
wg
 
sync
.
Wa™Group


898 
¡©
 :ğ&
¡©i¡ics
{
m­d©a
: 
	`make
(
m­
[
¡ršg
]
št32
)}

900 
¡¬t
 :ğ
time
.
	`Now
()

901 
j
 :ğ0; j < 
ıusNum
; j++ {

903 
wg
.
	`Add
(1)

904 
go
 
	`func
(
id
 , 
¡¬tTime
 
time
.
Time
) {

905 
	`pubWÜk”
(
tıCÚ
, 
uidsChª
, 
ex™Chª
, 
id
, 
¡¬tTime
, 
¡©
, 
champId
)

906 
wg
.
	`DÚe
()

907 }(
j
, 
¡¬t
)

910 
wg
.
	`Wa™
()

911 
’d
 :ğ
time
.
	`Now
()

912 
du¿tiÚ
 :ğ
’d
.
	`Sub
(
¡¬t
)

915 
fmt
.
	`Pršn
("\nstatistics:")

916 
fmt
.
	`Prštf
("%-30  %s\n", "du¿tiÚ", 
du¿tiÚ
)

918 
key
, 
v®ue
 :ğ
¿nge
 
¡©
.
m­d©a
 {

919 
fmt
.
	`Prštf
("%-30  %5d„ows\n", 
key
, 
v®ue
)

923 
	}
}

	@
1
.
1
/usr/include
1
15
texas_mysql.go
